#include "STC89C5xRC_RDP.h"
#include <string.h>
#include <intrins.h>
#include "main.h"
//#include "slrc531.h"
//#include "iso14443a.h"
//#include "iso14443b.h"
#include "12864.h"
#include "DS1302.H"
#include <absacc.h>
#include "STC15EROM.h"
#include "KEY.H"
#include "SMS.H"
#include "SC8020B.H"
#include "Mentor.h"
//#include "ds18b20.H"
//硬件版本号         
uint sum_id;
//uint SET_DIS = 1;
uchar nian = 13;
uchar yue  = 10;
uchar ri   = 31;
uchar user_channel = 0;
uchar chan_chose;
//bit mentor_off=0;
unsigned char s = 0; //在中断函数中
unsigned char Time_Range=0;
unsigned char idata set_led_time[4]={18,30,6,30};
unsigned char idata set_power_time[4]={18,30,6,30};//开关机时间，只能通过远程设置
unsigned int led_start,led_end;
unsigned int power_start,power_end;	 //开关机时间，只能通过远程设置
bit led_on=0;
extern unsigned char set_num,tab_num,store_timerange,store_ledtime[4];//删去了extern
unsigned char TIME[6];
extern unsigned char t_tmp[6];
extern unsigned char num[11];
extern unsigned char mach_num[9];
//uchar uni_nan[2]={0x37,0x75};
//uchar uni_nu[2]={0x73,0x59};
uchar uni_age[4]={0x00,0x00,0x00,0x00,};
//uchar uni_time[]={};
uchar uni_comma[2]={0x0c,0xff};
bit b;
bit b_flesh=0;
unsigned int min,sec;
//unsigned char int0_flag=0;
unsigned int a;
unsigned char start_long_set=0,long_set=0,tmp_show,for_num2_clr;
unsigned int aa;//,set_long_time,set_long_time_flag;
unsigned char update_logo=0;

uchar ee_indx=0;
uchar ee_id=0;

uchar ask_a=0;
bit   ask_it=0;
unsigned char xdata eesector[] =
{
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
unsigned char xdata dd_1[]=
{
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00

};

unsigned char code Cl[]=
{
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00

};

unsigned char code dig_9[]=
{
 0x60,0x90,0x90,0x90,0x90,0x90,0x90,0x90,0xa0,0x60,//'0'
 0x60,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x70,//'1'
 0x60,0x90,0x90,0x10,0x20,0x20,0x40,0x40,0x90,0xf0,//'2'
 0x60,0x90,0x90,0x10,0x60,0x10,0x10,0x90,0x90,0x60,//'3'
 0x10,0x30,0x50,0x50,0x90,0x90,0xf8,0x10,0x10,0x38,//'4'
 0xf0,0x80,0x80,0xe0,0x90,0x10,0x10,0x90,0x90,0x60,//'5'
 0x60,0xa0,0x80,0x80,0xe0,0x90,0x90,0x90,0x90,0x60,//'6'
 0xf0,0x90,0x20,0x20,0x40,0x40,0x40,0x40,0x40,0x40,//'7'
 0x60,0x90,0x90,0x90,0x60,0xa0,0x90,0x90,0x90,0x60,//'8'
 0x60,0x90,0x90,0x90,0x90,0x70,0x10,0x10,0x60,0x60,//'9'
 0x00,0x00,0x00,0x00,0xf8,0x00,0x00,0x00,0x00,0x00,//'--'
 0x00,0x00,0x00,0x60,0x60,0x00,0x60,0x60,0x00,0x00,//':'
 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 //' '

};

unsigned char code Chinese_SHU[]=
{
 0x08,0x20,0x49,0x20,0x2A,0x20,0x08,0x3E,
 0xFF,0x44,0x2A,0x44,0x49,0x44,0x88,0xA4,
 0x10,0x28,0xFE,0x28,0x22,0x10,0x42,0x10,
 0x64,0x28,0x18,0x28,0x34,0x44,0xC2,0x82  /*"数",0*/
};

unsigned char code ALL_ZERO[32]=
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

 /* unsigned char code AD_1[]=
 {
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 1
//  0x00,0x03,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 2
//  0x00,0x1f,0xfe,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x7f,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0xfc,0x03,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x01,0xe0,0x00,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x07,0xe0,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x07,0xc0,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x0f,0x80,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 9
//  0x0e,0x00,0x00,0x09,0xe0,0x7c,0x00,0x28,0x02,0x20,0x47,0x88,0x91,0x1e,0x04,0x00,// 10
//  0x1e,0x00,0x00,0x03,0xe0,0xfc,0x00,0x2c,0x02,0x20,0xf4,0x8a,0xa0,0x92,0x0f,0xe0,// 11
//  0x1c,0x00,0x00,0x07,0xc1,0xf8,0x00,0x20,0x1f,0xfd,0x24,0x92,0xc8,0x92,0x08,0x20,
//  0x1c,0x00,0x00,0x07,0x93,0xf8,0x00,0x27,0xc0,0x81,0xfc,0xbf,0x88,0x22,0x14,0x40,// 13
//  0x3c,0x00,0x00,0x0f,0xb3,0xf3,0x01,0xf8,0x0f,0xf8,0x67,0x81,0x8b,0x41,0xa3,0x80,// 14
//  0x3c,0x00,0x00,0x0f,0x7b,0xf7,0x00,0x31,0x00,0x80,0xd4,0x9e,0xf1,0x00,0x07,0xc0,// 15
//  0x3c,0x00,0x00,0x1f,0x79,0xe7,0x80,0x11,0x1f,0xfd,0x88,0x12,0x01,0x3f,0x38,0x38// 16
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x07,0xE0,0x01,0xF8,0x00,0x1F,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x07,0xF8,0x01,0xF8,0x00,0x3F,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x03,0xFF,0x01,0xF8,0x03,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x07,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x1F,0x1F,0xFF,0xE3,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xFF,0xF8,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x01,0xFC,0x07,0xFC,0x00,0x00,0x03,0xFC,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x03,0xF0,0x00,0xFC,0x00,0x00,0x0F,0xFE,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0xFF,0xE3,0xE0,0x00,0x3E,0x00,0x01,0xFF,0xE0,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0xFF,0xE3,0xE0,0x00,0x3E,0x00,0x07,0xFF,0x80,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x03,0xF0,0x00,0x7E,0x00,0x7F,0xFE,0x00,0x00,0x00,0x00
  };
  unsigned char code AD_2[]=
  {
0x00,0x00,0x00,0x00,0x00,0x03,0xF8,0x00,0x7C,0x01,0xFF,0xF8,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x01,0xFC,0x40,0xFC,0x1F,0xFF,0xF0,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xC0,0x78,0x7F,0xFF,0xE0,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xC0,0x07,0xFF,0xFF,0x80,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x03,0xFE,0x00,0x00,0x00,0x3F,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x7F,0xF8,0x07,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x0F,0xFE,0x03,0xFF,0xFF,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0xFC,0x7F,0xFC,0x1F,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x03,0x87,0x9F,0xFF,0x80,0x0F,0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x0C,0xFF,0xFF,0xFF,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xFF,0xFF,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  //  0x3c,0x00,0x00,0x1e,0x3c,0xe3,0x80,0x12,0x00,0x80,0x7f,0x1e,0x99,0x21,0x1f,0xe0,
//  0x3c,0x00,0x00,0x3e,0x3c,0x61,0xe0,0x0c,0x1f,0xfc,0x41,0x12,0xb1,0x12,0x11,0x20,// 18
//  0x3c,0x00,0x06,0x3c,0x1e,0x41,0xe0,0x08,0x40,0x80,0x7f,0x1e,0xc1,0x0c,0x1f,0xe0,
//  0x3c,0x00,0x06,0x7c,0x1e,0x00,0xf0,0x14,0x41,0x40,0x41,0x12,0x88,0xcc,0x11,0x20,
//  0x1e,0x00,0x06,0x78,0x0e,0x00,0xf0,0x62,0x86,0x30,0x7f,0x12,0x88,0x33,0x1f,0xe0,// 21
//  0x1e,0x00,0x06,0x78,0x0e,0x00,0x78,0x81,0x98,0x0c,0x41,0x16,0xf0,0x40,0x80,0x00,
//  0x0f,0x80,0x06,0x00,0x00,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x0f,0xc0,0x06,0x00,0xa0,0x7f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x0f,0xe0,0x06,0x00,0x80,0x08,0x00,0x55,0x55,0x43,0x29,0x8f,0x9c,0xc1,0x98,0xf8,// 25
//  0x07,0xf0,0x06,0x07,0xf8,0x7f,0x00,0x55,0x55,0x44,0xaa,0x52,0x45,0x22,0x25,0x24,
//  0x03,0xff,0xfe,0x00,0x80,0x08,0x00,0x55,0x55,0x40,0xaa,0x52,0x49,0x22,0x25,0x24,
//  0x00,0xff,0xfe,0x00,0x98,0x7f,0x00,0x55,0x55,0x43,0xa9,0xd2,0x49,0x22,0x25,0x24,// 28
//  0x00,0x7f,0xfe,0x00,0xe0,0x08,0x00,0x55,0x55,0x44,0xa8,0x52,0x49,0x22,0x25,0x24,
//  0x00,0x1f,0xfe,0x07,0x80,0x7f,0x00,0x69,0xa6,0x84,0x98,0x52,0x51,0x22,0x25,0x24,// 30
//  0x00,0x00,0x00,0x00,0x78,0x77,0x00,0x28,0xa2,0x97,0x92,0x52,0x5d,0x29,0x99,0x24,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x61,0x80,0x00,0x00,0x00,0x00// 32
  };
  unsigned char code AD_3[]=
  {
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 35
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x01,0x00,0x7e,0x10,0x00,0x00,0x11,0x00,0x04,0x00,0x10,0x80,0x40,0x00,0x00,
//  0x00,0x4f,0xf0,0x42,0x10,0x00,0x00,0x11,0x40,0x1f,0xc0,0x12,0x80,0x2f,0xf0,0x00,// 38
//  0x00,0x21,0x00,0x7e,0x50,0x7f,0xe0,0x21,0x20,0x10,0x40,0x22,0x40,0x20,0x80,0x00,
//  0x00,0x07,0xe0,0x40,0x50,0x00,0x00,0x21,0x00,0x1f,0xc0,0x24,0x40,0x00,0x80,0x00,
//  0x00,0xe1,0x00,0x48,0x50,0x00,0x00,0x6f,0xf0,0x10,0x40,0x64,0x20,0xe4,0x80,0x00,// 41
//  0x00,0x2f,0xf0,0x7e,0x50,0x00,0x00,0xa1,0x00,0x1f,0xd0,0xaf,0xd0,0x24,0xe0,0x00,
//  0x00,0x24,0x20,0x6a,0x50,0x00,0x00,0x21,0x00,0x10,0x60,0x32,0x40,0x24,0x80,0x00,
//  0x00,0x27,0xe0,0xaa,0x50,0x00,0x00,0x21,0x00,0x7f,0xc0,0x22,0x40,0x24,0x80,0x00,// 44
//  0x00,0x2c,0x20,0xaa,0x50,0x00,0x00,0x20,0x80,0x01,0x40,0x22,0x40,0x2c,0x80,0x00,
//  0x00,0x37,0xe0,0xaa,0x50,0x00,0x00,0x20,0x90,0x06,0x40,0x24,0x40,0x34,0x80,0x00,// 46
//  0x00,0x24,0x20,0x2e,0x10,0xff,0xf0,0x20,0x50,0x18,0x40,0x24,0x40,0x2f,0xf0,0x00,
//  0x00,0x04,0x60,0x08,0x30,0x00,0x00,0x20,0x30,0xe1,0x80,0x28,0xc0,0x00,0x00,0x00
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x08,0x80,0x00,0x02,0x18,0x20,0x80,0x04,0x02,0x10,0x30,0x02,0x00,0xc8,0x00,
  0x03,0xf9,0x03,0xfe,0x0c,0x10,0x20,0x80,0x02,0x7e,0x08,0x28,0x22,0x00,0x90,0x00,
  0x01,0x45,0x04,0x00,0x18,0x90,0x20,0x80,0x02,0x42,0x08,0x28,0x14,0x01,0x1f,0x80,
  0x01,0x42,0x04,0x04,0x08,0x50,0xff,0xf0,0x00,0xfe,0x03,0xfc,0x14,0x01,0x28,0x80,
  0x01,0x5f,0x84,0xf8,0x08,0x10,0x20,0x80,0x07,0x42,0x02,0x20,0x04,0x13,0x45,0x00,
  0x01,0xc2,0x04,0x00,0x1e,0x10,0x20,0x80,0x09,0xfe,0x3a,0x28,0x7f,0xf1,0x15,0x00,
  0x01,0x42,0x04,0x02,0x08,0x90,0x2f,0xe0,0x09,0x20,0x13,0xe8,0x04,0x11,0x24,0x80,
  0x01,0x42,0x48,0xfc,0x0e,0x50,0x72,0x20,0x05,0x3f,0x12,0xa8,0x06,0x11,0x44,0x80,
  0x01,0xff,0x84,0xa6,0x1a,0x18,0xa2,0x40,0x06,0x49,0x12,0xb0,0x09,0x90,0x0c,0x00,
  0x01,0x46,0x04,0x98,0x28,0x78,0x22,0x40,0x07,0xc9,0x12,0x90,0x08,0xa0,0x50,0x00,
  0x01,0x65,0x04,0x90,0x29,0x90,0x21,0x80,0x03,0xd5,0x1e,0x90,0x10,0x20,0x68,0x80,
  0x03,0xc5,0x04,0x88,0x08,0x10,0x20,0x80,0x0c,0x6a,0x1d,0x90,0x20,0x21,0x48,0x40,
  0x00,0x48,0x88,0xb6,0x08,0x10,0x23,0x40,0x00,0x52,0x15,0x4c,0x20,0x23,0x42,0x40,
  0x00,0x70,0x48,0xc2,0x08,0x10,0x64,0x30,0x00,0x06,0x08,0x84,0xc0,0xe0,0x7f,0x00,
  0x00,0x00,0x00,0x00,0x00,0x10,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  
  };
 */

 unsigned char code ji_sheng_1[]=
 {
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x7e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x8e,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x1d,0x01,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x3a,0x07,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x17,0x7b,0x0e,0x18,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x74,0x38,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x1b,0x7a,0x38,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x10,0xee,0xf0,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x55,0xd3,0x60,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x3b,0xa1,0x80,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x1f,0x41,0xe0,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x3c,0x83,0xbe,0x38,0x00,0x00,0x00,0x00,0x00,0x00
 };
  unsigned char code ji_sheng_2[]=
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x1f,0x07,0x8f,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x54,0x07,0x03,0xe0,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x0e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x14,0x18,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x60,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x3d,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0xf0,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x20,0x02,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xa8,0x91,0xd0,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x64,0x4b,0x90,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xff,0xfd,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0xca,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  };
  unsigned char code ji_sheng_3[]=
  {
//  0x08,0x20,0x50,0x81,0x00,0x40,0x22,0x1f,0xe0,0x80,0x0a,0x09,0x20,0x8c,0x09,0xe0,
//  0x08,0x20,0x50,0x89,0x07,0xfd,0xff,0xd0,0x20,0xf8,0x7f,0xc9,0x30,0x88,0x09,0x20,
//  0x04,0x20,0x42,0x89,0x01,0x10,0x22,0x1f,0xe1,0x08,0x0a,0x49,0x00,0x88,0x3f,0x20,
//  0x00,0x20,0x52,0x8f,0xf2,0x08,0x44,0x10,0x23,0xfe,0x7f,0xcf,0xfb,0xef,0x89,0x20,
//  0x1d,0xfc,0xf2,0x91,0x07,0xf8,0x87,0x9f,0xe6,0x22,0x4a,0x01,0x01,0x09,0x09,0x20,
//  0x04,0x23,0xc2,0x91,0x00,0x00,0xa8,0x90,0x22,0x22,0x7f,0xc2,0x01,0x19,0x19,0x20,
//  0x04,0x20,0x4a,0xa1,0x03,0xf8,0xe8,0x9f,0xe3,0xfe,0x12,0x43,0xf9,0xe9,0x1d,0x20,
//  0x04,0x20,0x5a,0x9f,0xf2,0x08,0x44,0x90,0x22,0x40,0x3f,0xc3,0x11,0x29,0x2d,0x20,
//  0x04,0x20,0x52,0x81,0x03,0xf8,0x84,0xbf,0xf8,0x60,0x60,0x85,0x11,0x25,0x29,0x28,
//  0x04,0xa0,0x62,0x81,0x02,0x08,0xa2,0x80,0x00,0xa1,0x24,0x84,0xa1,0x22,0x29,0x28,
//  0x05,0x20,0xc8,0x81,0x03,0xf8,0xc0,0x84,0x40,0xa1,0x24,0x88,0x41,0x27,0x09,0x28,
//  0x06,0x23,0x28,0x81,0x02,0x08,0x30,0x98,0x33,0x21,0x0b,0x09,0xb1,0x29,0x89,0x28,
//  0x0c,0x20,0x1b,0xbf,0xfa,0x18,0xc7,0x30,0x16,0x1e,0x70,0xd6,0x0b,0x50,0xcb,0x38,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
//  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,// 35
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x01,0x00,0x7e,0x10,0x00,0x00,0x11,0x00,0x04,0x00,0x10,0x80,0x40,0x00,0x00,
  0x00,0x4f,0xf0,0x42,0x10,0x00,0x00,0x11,0x40,0x1f,0xc0,0x12,0x80,0x2f,0xf0,0x00,// 38
  0x00,0x21,0x00,0x7e,0x50,0x7f,0xe0,0x21,0x20,0x10,0x40,0x22,0x40,0x20,0x80,0x00,
  0x00,0x07,0xe0,0x40,0x50,0x00,0x00,0x21,0x00,0x1f,0xc0,0x24,0x40,0x00,0x80,0x00,
  0x00,0xe1,0x00,0x48,0x50,0x00,0x00,0x6f,0xf0,0x10,0x40,0x64,0x20,0xe4,0x80,0x00,// 41
  0x00,0x2f,0xf0,0x7e,0x50,0x00,0x00,0xa1,0x00,0x1f,0xd0,0xaf,0xd0,0x24,0xe0,0x00,
  0x00,0x24,0x20,0x6a,0x50,0x00,0x00,0x21,0x00,0x10,0x60,0x32,0x40,0x24,0x80,0x00,
  0x00,0x27,0xe0,0xaa,0x50,0x00,0x00,0x21,0x00,0x7f,0xc0,0x22,0x40,0x24,0x80,0x00,// 44
  0x00,0x2c,0x20,0xaa,0x50,0x00,0x00,0x20,0x80,0x01,0x40,0x22,0x40,0x2c,0x80,0x00,
  0x00,0x37,0xe0,0xaa,0x50,0x00,0x00,0x20,0x90,0x06,0x40,0x24,0x40,0x34,0x80,0x00,// 46
  0x00,0x24,0x20,0x2e,0x10,0xff,0xf0,0x20,0x50,0x18,0x40,0x24,0x40,0x2f,0xf0,0x00,
  0x00,0x04,0x60,0x08,0x30,0x00,0x00,0x20,0x30,0xe1,0x80,0x28,0xc0,0x00,0x00,0x00
 };

//
bit ad;					

uchar code SAM_V_STATE[]={0xaa,0xaa,0xaa,0x96,0x69,0x00,0x03,0x11,0xff,0xed};
uchar code SAM_V_FIND[]={0xaa,0xaa,0xaa,0x96,0x69,0x00,0x03,0x20,0x01,0x22};
uchar code SAM_V_SELE[]={0xaa,0xaa,0xaa,0x96,0x69,0x00,0x03,0x20,0x02,0x21};
uchar code SAM_V_READ[]={0xaa,0xaa,0xaa,0x96,0x69,0x00,0x03,0x30,0x01,0x32};
uchar idata com_buf[173];//其实只需要接收172个字节。最后一个字节用来存储后续无用数据。
uchar recv_num;

//接收策略更新
//uchar idata com2_buf[12];
uchar xdata com2_cmd_buf[254];
uchar com2_cmd_num=0;
//uchar com2_recv_num=0;
bit update_strat = 0;
uchar upage=60;
uchar downage=20;
bit ok_to_update=0;//串口2接收有用数据开始标志，避免在发短信时接收无用的握手数据

bit which_term=0;
uchar the_term=0;
bit get_the_term = 0;
bit next_is_data = 0;

//短信提示功能
bit ch1_ans=0;
bit ch2_ans=0;
bit ch3_ans=0;
bit ch4_ans=0;
bit send_no_goods=0;
uchar no_goods_chan=1;

uchar wait_send;
void update_stratage()
{
	Remote_Set();
	//先更新领用间隔时间
	if((Time_Range/10==(com2_cmd_buf[128]-0x30))&&(Time_Range%10==(com2_cmd_buf[129]-0x30)))
	{}
	else
	{Time_Range=(com2_cmd_buf[128]-0x30)*10+(com2_cmd_buf[129]-0x30);Write_E(57,0,Time_Range);}
	//更新LED时间
	if((set_led_time[0]/10==(com2_cmd_buf[100]-0x30))&&(set_led_time[0]%10==(com2_cmd_buf[101]-0x30)))
	{}
	else
	{
	set_led_time[0]=(com2_cmd_buf[100]-0x30)*10+(com2_cmd_buf[101]-0x30);	
	led_start = set_led_time[0]*60+set_led_time[1];
	led_end = set_led_time[2]*60+set_led_time[3];
	Write_E(57,1,set_led_time[0]);	
	}


	if((set_led_time[1]/10==(com2_cmd_buf[102]-0x30))&&(set_led_time[1]%10==(com2_cmd_buf[103]-0x30)))
	{}
	else
	{
	set_led_time[1]=(com2_cmd_buf[102]-0x30)*10+(com2_cmd_buf[103]-0x30);	
	led_start = set_led_time[0]*60+set_led_time[1];
	led_end = set_led_time[2]*60+set_led_time[3];
	Write_E(57,2,set_led_time[1]);	
	}

	if((set_led_time[2]/10==(com2_cmd_buf[104]-0x30))&&(set_led_time[2]%10==(com2_cmd_buf[105]-0x30)))
	{}
	else
	{
	set_led_time[2]=(com2_cmd_buf[104]-0x30)*10+(com2_cmd_buf[105]-0x30);	
	led_start = set_led_time[0]*60+set_led_time[1];
	led_end = set_led_time[2]*60+set_led_time[3];
	Write_E(57,3,set_led_time[2]);	
	}

	if((set_led_time[3]/10==(com2_cmd_buf[106]-0x30))&&(set_led_time[3]%10==(com2_cmd_buf[107]-0x30)))
	{}
	else
	{
	set_led_time[3]=(com2_cmd_buf[106]-0x30)*10+(com2_cmd_buf[107]-0x30);	
	led_start = set_led_time[0]*60+set_led_time[1];
	led_end = set_led_time[2]*60+set_led_time[3];
	Write_E(57,4,set_led_time[3]);	
	}
	
	//更新开关机时间
	if((set_power_time[0]/10==(com2_cmd_buf[116]-0x30))&&(set_power_time[0]%10==(com2_cmd_buf[117]-0x30)))
	{}
	else
	{
	set_power_time[0]=(com2_cmd_buf[116]-0x30)*10+(com2_cmd_buf[117]-0x30);	
	power_start = set_power_time[0]*60+set_power_time[1];
	power_end = set_power_time[2]*60+set_power_time[3];
	Write_E(57,33,set_power_time[0]);	
	}


	if((set_power_time[1]/10==(com2_cmd_buf[118]-0x30))&&(set_power_time[1]%10==(com2_cmd_buf[119]-0x30)))
	{}
	else
	{
	set_power_time[1]=(com2_cmd_buf[118]-0x30)*10+(com2_cmd_buf[119]-0x30);	
	power_start = set_power_time[0]*60+set_power_time[1];
	power_end = set_power_time[2]*60+set_power_time[3];
	Write_E(57,34,set_power_time[1]);	
	}

	if((set_power_time[2]/10==(com2_cmd_buf[120]-0x30))&&(set_power_time[2]%10==(com2_cmd_buf[121]-0x30)))
	{}
	else
	{
	set_power_time[2]=(com2_cmd_buf[120]-0x30)*10+(com2_cmd_buf[121]-0x30);	
	power_start = set_power_time[0]*60+set_power_time[1];
	power_end = set_power_time[2]*60+set_power_time[3];
	Write_E(57,35,set_power_time[2]);	
	}

	if((set_power_time[3]/10==(com2_cmd_buf[122]-0x30))&&(set_power_time[3]%10==(com2_cmd_buf[123]-0x30)))
	{}
	else
	{
	set_power_time[3]=(com2_cmd_buf[122]-0x30)*10+(com2_cmd_buf[123]-0x30);	
	power_start = set_power_time[0]*60+set_power_time[1];
	power_end = set_power_time[2]*60+set_power_time[3];
	Write_E(57,36,set_power_time[3]);	
	}
	
	
	
}
uint num_times=0;
void main( )
{    
 	  uchar t_tmp;
	  uint del_1;
	  uint born_year;
	  uint age;
//	  uint tempr;
	  a = 0;
	  aa=0;
	  ad = 0;
	  tmp_show = 0;
	
	  InitializeSystem( );
	  Ini_UART();
	  
	  EA = 1;
	  
	  ET0 = 1;
//	  ET1 = 1;
	


	  TMOD |= 0X01;
	  TH0 = 0Xc8;
	  TL0 = 0Xc0;

//	  TH1 = 0X3c;
//	  TL1 = 0Xb0;

	  Init_DS1302();
	  DelayMs(20);
	  RE_DS1302();
	  initial_LCD();
     
	 	  
	

	  Clean_12864_GDRAM();
	  WriteCommand(0x30);
	  ClrScreen();
	   Draw_LOGO(ji_sheng_1,ji_sheng_2,ji_sheng_3);

	  Draw_Dig(1,2,dig_9,dd_1);
	  Draw_Dig(2,0,dig_9,dd_1);
	  Draw_Dig(3,TIME[0]/16,dig_9,dd_1);
	  Draw_Dig(4,TIME[0]%16,dig_9,dd_1);
	  Draw_Dig(5,10,dig_9,dd_1);
	  Draw_Dig(6,TIME[1]/16,dig_9,dd_1);
	  Draw_Dig(7,TIME[1]%16,dig_9,dd_1);
	  Draw_Dig(8,10,dig_9,dd_1);
	  Draw_Dig(9,TIME[2]/16,dig_9,dd_1);
	  Draw_Dig(10,TIME[2]%16,dig_9,dd_1);
	  Draw_Dig(15,TIME[3]/16,dig_9,dd_1);
	  Draw_Dig(16,TIME[3]%16,dig_9,dd_1);
	  Draw_Dig(17,11,dig_9,dd_1);
	  Draw_Dig(18,TIME[4]/16,dig_9,dd_1);
	  Draw_Dig(19,TIME[4]%16,dig_9,dd_1);
	  
	  LCD_16128Graphic(0,4,dd_1); 
	  LCD_16128Graphic(1,4,dd_1);
	  LCD_16128Graphic(2,4,dd_1); 
	  LCD_16128Graphic(3,4,dd_1);
	  LCD_16128Graphic(4,4,dd_1); 
	  LCD_16128Graphic(5,4,dd_1);
	  LCD_16128Graphic(6,4,dd_1); 
	  LCD_16128Graphic(7,4,dd_1);

	  

 	   
	 
	    
		//TR1 = 1;
	//ClrScreen();
	for(del_1=0;del_1<1000;del_1++)
		 DelayMs(200);
//	for(del_1=0;del_1<500;del_1++)
//		 DelayMs(200);
//	for(del_1=0;del_1<1000;del_1++)
//		 DelayMs(200);
//	for(del_1=0;del_1<500;del_1++)
//		 DelayMs(200);	 
	lcdak = 0;
	TR0 = 1;
	Init_UART_SMS();init_gprs();
	
	BEEP(200);
	AUXR1 = 0X00;//串口在3.0,3.1
     while ( 1 )
     { 
			
		 if(update_logo == 1)
		 {//update_stratage();
		 update_logo = 0;}
		  //{}
		
	
		 if(ask_it==1){
		    LCD_Display_Clock(dig_9,dd_1);
		  
			if(set_num == 0){ 
				//BEEP(20);
					request();
				
			}
		 
		    ask_it = 0;
		  }


			


		if(set_num == 0){
						 	if((TIME[5]/16*10+TIME[5]%16)%4 == 0)
							{
								
								if(ad == 1)
								  {
								  if(t_tmp!=TIME[5]){
								   LCD_PutString(0,1,"                ");
									LCD_PutString(0,2,"                ");  
						LCD_PutString(0,3,"                ");  
								  Draw_LOGO(ji_sheng_1,ji_sheng_2,ji_sheng_3);
								  ad = 0;}
								 // update_logo = 1;
								   
								  }
								  else
								  {
								  if(t_tmp!=TIME[5]){
								 Draw_LOGO(Cl,Cl,Cl);
									  //WriteCommand(0x01);  //清屏
//									  LCD_PutString(0,1,"当前温度：    度");
//									  
//									  WriteCommand(0x86);
//									  tempr= readtempr();
//									  WriteData('0'+tempr/100);
//									  WriteData('0'+tempr%100/10);
									  LCD_PutString(0,2,"本机已发放药具：");
									  LCD_PutString(0,3,"          盒    ");
									  WriteCommand(0x30);
									  WriteCommand(0x89);
									// WriteData(0X30+num_times/10000);
									  WriteData(0X30+num_times/1000%10);
									  WriteData(0X30+num_times/100%10);
									  WriteData(0X30+num_times/10%10);
									  WriteData(0X30+num_times%10);  
								  ad = 1;
								  }
								 // update_logo = 1;
								  
								  }
								  
								  t_tmp = TIME[5];
							 } 			 
			  			}
	 if(set_num ==0||set_num==1||set_num==2||set_num==3 || set_num==4||set_num==5)
	 	set_table();
	 /*在设置界面的第一三四五四个界面闪烁*/
	 if(set_num == 1 || set_num == 3 || set_num==4||set_num==5){
	 		//TR0 = 0;
		 	if(b_flesh==1){
			if(b==1)
			flesh_set();
			else
			flesh_clr();
			}
			//TR0 = 1;
		}
	 /*在用户刷卡后进入选择货道状态*/
	  if(set_num == USER_STATE){
		  if(user_channel==0)
		 	user_ch(); 		
		}

		
	 /*在用户时间限制或是无药品时显示一段时间的错误提示*/	
	  	if(set_num == USER_STATE_ERR||set_num == NO_INV_STATE){
				if(tmp_show>8)
					{
						set_num = 0;
						tmp_show = 0;
						user_channel = 0;
						for(s=1;s<4;s++)		
							LCD_PutString(0,s,"                ");
			//			aa = 225;
					}
			}
	  	if(set_num == USER_STATE)
		{
				if(tmp_show>14)
					{
						set_num = 0;
						tmp_show = 0;
						user_channel = 0;
						for(s=1;s<4;s++)		
							LCD_PutString(0,s,"                ");
			//			aa = 225;
					}
			}
		/*显示一段时间的请取货界面，电机状态另行控制*/
		if(set_num == GET_INV_STATE) //如果用户不取货
		{
					
			
				if((tmp_show>16) && (a>5)) //到请取货状态
				{
					
					
					user_channel=0;
					

			set_num = TO_THANKS;
			TR0 = 0;
			MENTOR_OFF();
			tmp_show = 0;
			TH0 = 0Xc8;
			TL0 = 0Xc0;
			a=0;
			TR0 = 1;
			LCD_PutString(0,1,"                ");
			LCD_PutString(0,2,"                ");
			LCD_PutString(0,3,"                ");
			DisplayLcd(GET_INV); 
			sc_speech(5);
				}

			

			if(pos2 == 0)
				set_num = POS_ON;
		//	if(tmp_show>1)
			//a = 0;
		
		}
		//if(set_num!=0&&set_num!=USER_STATE&&set_num!=USER_STATE_ERR&&set_num!=POS_ON&&set_num!=GET_INV_STATE){
		/*在维护设置的三个界面中，如一段时间不操作，也回退到待机界面，有BUG*/
		if(set_num==1||set_num==2||set_num==3||set_num==4||set_num == 5){
			if(tmp_show>15){		
				if(set_num == 2)
				Time_Range = store_timerange;

				if(set_num == 3)
				{
				for(s=1;s<5;s++)	
				set_led_time[s-1] = store_ledtime[s-1];
				}

				start_long_set = 0;
				long_set = 0;
				set_num = 0;			
				tmp_show = 0;
				//ClrScreen();
//				BEEP(50);
				for(s=1;s<4;s++){							
					LCD_PutString(0,s,"                ");
					}
				
			//	aa = 235;
				}
				

		}
		
		if(set_num == POS_ON)
		{
	 DelayMs(2000); //一次延时的方式
		  //DelayMs(10);
		if(pos2 == 0)
		{
			// 	DelayMs(30);  //一次延时的方式
			set_num = POS_ON;
			
				if((tmp_show>12) && (a>5)) //到请取货状态
				{
					
					
					user_channel=0;
					

			set_num = TO_THANKS;
			TR0 = 0;
			MENTOR_OFF();
			tmp_show = 0;
			TH0 = 0Xc8;
			TL0 = 0Xc0;
			a=0;
			TR0 = 1;
			LCD_PutString(0,1,"                ");
			LCD_PutString(0,2,"                ");
			LCD_PutString(0,3,"                ");
			DisplayLcd(GET_INV); 
			sc_speech(5);
				}		
			}
			else{
			set_num = TO_THANKS;
			TR0 = 0;
			MENTOR_OFF();
			user_channel = 0;
			tmp_show = 0;
			TH0 = 0Xc8;
			TL0 = 0Xc0;
			a=0;
			TR0 = 1;
			LCD_PutString(0,1,"                ");
			LCD_PutString(0,2,"                ");
			LCD_PutString(0,3,"                ");
			DisplayLcd(GET_INV); 
			sc_speech(5); 
			}
		}

	

if(set_num==TO_THANKS){

		if(tmp_show>6){
		//LCD_PutString(0,1,"                "); 
	    LCD_PutString(0,2,"    谢谢使用!   ");
	    //LCD_PutString(0,3,"                ");
			set_num = THANKS;
			
		}
		
	}		
		if(set_num==THANKS){

		
		if(tmp_show>15){
	
					sc_speech(7);
					born_year = 1000*(com_buf[50]-0x30);
					born_year = 100*(com_buf[52]-0x30)+born_year;
					born_year = 10*(com_buf[54]-0x30)+born_year;
					born_year = (com_buf[56]-0x30)+born_year;
					age = 2000 + TIME[0]/16*10 + TIME[0]%16-born_year;
				    send_net(com_buf,age,chan_chose);
				  	 //TR0 = 0;
				for(s=1;s<4;s++)		
					 LCD_PutString(0,s,"                "); 	
				   tmp_show = 0;
				   set_num = 0;				   
					 a=0;
			
					 //aa = 235;	
					 //TR0 = 1;
			}

		}	 
	   
     }
	
}



/////////////////////////////////////////////////////////////////////
//系统初始化
/////////////////////////////////////////////////////////////////////
void InitializeSystem()
{
	uchar j;

	//需要设置相应端口为推挽输出以保证正常电平
	//---------------1.M1=1,M0=0:高阻
	//---------------2.M1=0,M0=1:推挽
//sbit     m1         =    P1^5;
//sbit     m2         =    P0^5;
//sbit     L298N_EA         =    P4^1;
//sbit     L298N_EB         =    P1^4;
//sbit     HC139_EN         =    P4^2;
//sbit     mled       =    P4^6;  
	P4M1 = 0X00;
	P4M0 = 0X46;
//	
//	P3M1 = 0X00;
//	P3M0 = 0X20;
//	
//	P2M1 = 0X00;
//	P2M0 = 0X00;
//	
	P1M1 = 0X00;
	P1M0 = 0X30;

	P0M1 = 0X00;
	P0M0 = 0X20;
	
	mled = 1;  //根据灯管启停时间和预设的时间，上电时应处于开启状态
	HC139_EN = 1;
	
	
		
//	for(j=0;j<58;j++)
//	 	C_EROM(j);
	j = R_EROM(57,0);
	if(j != 0xff)
	{
		Time_Range = j;
	
	} 	
	j = R_EROM(57,1);
	if(j != 0xff){
	set_led_time[0] = R_EROM(57,1);
	set_led_time[1] = R_EROM(57,2);
	set_led_time[2] = R_EROM(57,3);
	set_led_time[3] = R_EROM(57,4);
	}
	led_start = set_led_time[0]*60+set_led_time[1];
	led_end = set_led_time[2]*60+set_led_time[3];
		j = R_EROM(57,5);
	if(j != 0xff){
	num[0] = R_EROM(57,5);
	num[1] = R_EROM(57,6);
	num[2] = R_EROM(57,7);
	num[3] = R_EROM(57,8);
		num[4] = R_EROM(57,9);
	num[5] = R_EROM(57,10);
	num[6] = R_EROM(57,11);
	num[7] = R_EROM(57,12);
		num[8] = R_EROM(57,13);
	num[9] = R_EROM(57,14);
	num[10] = R_EROM(57,15);
	
	}
	j = R_EROM(57,16);
	if(j != 0xff){
	mach_num[0] = R_EROM(57,16);
	mach_num[1] = R_EROM(57,17);
	mach_num[2] = R_EROM(57,18);
	mach_num[3] = R_EROM(57,19);
		mach_num[4] = R_EROM(57,20);
	mach_num[5] = R_EROM(57,21);
	mach_num[6] = R_EROM(57,22);
	mach_num[7] = R_EROM(57,23);
		mach_num[8] = R_EROM(57,24);
	
	
	}
	j = R_EROM(57,25);
	if(j != 0xff){
	
	downage = R_EROM(57,25);
	}
	j = R_EROM(57,26);
	if(j != 0xff){
	
	upage = R_EROM(57,26);
	}

	j = R_EROM(57,27);
	if(j != 0xff){
	ee_indx = R_EROM(57,27);
	ee_id   = R_EROM(57,28);
	}
	
	j = R_EROM(57,29);
	if(j != 0xff)
		num_times = j;
	j = R_EROM(57,30);
	if(j != 0xff)
		num_times = j*10+num_times;
	j = R_EROM(57,31);
	if(j != 0xff)
		num_times = j*100+num_times;
	j = R_EROM(57,32);
	if(j != 0xff)
		num_times = j*1000+num_times;

	//开关机时间
		j = R_EROM(57,33);
	if(j != 0xff){
	set_power_time[0] = R_EROM(57,33);
	set_power_time[1] = R_EROM(57,34);
	set_power_time[2] = R_EROM(57,35);
	set_power_time[3] = R_EROM(57,36);
	}
	power_start = set_power_time[0]*60+set_power_time[1];
	power_end = set_power_time[2]*60+set_power_time[3];
	
}



 void BEEP(unsigned int i)
{
    unsigned int k;
	k=i*45;		
	buzz = 0;
	DelayMs(k);		
	buzz =1; 	
} 

void Write_E(uchar n,uint x,uchar dat)
{
	uint i;
	for(i=0;i<512;i++)
		eesector[i]=R_EROM(n,i);
	eesector[x] = dat;
	C_EROM(n);
	for(i=0;i<512;i++)
		W_EROM(n,i,eesector[i]);

}
void Write_EE_rec(uchar y,uchar m,uchar d)
{
	uint i;
	ee_id = ee_id+1;
	if(ee_id==16)
	{
		ee_id = 0;
		ee_indx = ee_indx+1;
		if(ee_indx == 57)
			ee_indx = 0;
	}
	
	for(i=0;i<512;i++)
		eesector[i]=R_EROM(ee_indx,i);
	
	eesector[ee_id*32+0] = y;
	eesector[ee_id*32+1] = m;
	eesector[ee_id*32+2] = d;
	for(i=0;i<8;i++)
		eesector[ee_id*32+3+i]=com_buf[14+i];
	C_EROM(ee_indx);
	for(i=0;i<512;i++)
		W_EROM(ee_indx,i,eesector[i]);
	
	Write_E(57,27,ee_indx);Write_E(57,28,ee_id);

} 
void request()	   // 寻卡(对身份证或其它TYPE B的卡的操作)
{
	

//	uchar age,born_year;  //去年年龄的计算 避免麻烦

//读卡器响应格式//
/*
Preamble --------5字节
Len1     --------1字节
Len2     --------1字节
SW1      --------1字节
SW2      --------1字节
SW3      --------1字节
Data     
CHK_SUM  --------1字节
*/


	IDR_Request();
	DelayMs(250);

	if(com_buf[9]==0x9f)
	{
		IDR_Select();
		DelayMs(250);
	
		if(com_buf[9]==0x90)
		{com_buf[9]=0;
			IDR_Read();
			DelayMs(8000);//等待阅读器响应和数据传输完成
			DelayMs(8000);
			if(com_buf[9]==0x90)
		{
			
			
			BEEP(50);	


			ri=DS1302Read(0x87);
			yue=DS1302Read(0x89);
			nian=DS1302Read(0x8d);
			ri=ri/16*10+ri%16;
			yue=yue/16*10+yue%16;
			nian=nian/16*10+nian%16;
			

			DelayMs(100);
			 
		//	if(((age>downage) && (age<upage)) && ((panduan(nian,yue,ri)== 0x01))){	   //两种情况可以取货：未曾拿过、过了限期
			if(panduan(nian,yue,ri)== 0x01){
				Draw_LOGO(Cl,Cl,Cl);
				LCD_PutString(0,1,"                ");
				LCD_PutString(0,2,"                ");  
				LCD_PutString(0,3,"                "); 
				DisplayLcd(SEL_CHAN);
				sc_speech(4);
				set_num = USER_STATE;
				user_channel = 0;			 
				tmp_show = 0;
			}
			else
			{	
				Draw_LOGO(Cl,Cl,Cl);
				LCD_PutString(0,1,"                ");
				LCD_PutString(0,2,"                ");  
				LCD_PutString(0,3,"                "); 
				DisplayLcd(ERR_MES);
				set_num = USER_STATE_ERR;tmp_show = 0;
				sc_speech(3);
					
			}

			}
		
		}
	}

}


uchar panduan(uchar y,uchar m, uchar d)
{
	

	unsigned int i,j;
	unsigned int dis;
	unsigned int num = 912;
	unsigned int num_tmp;
	unsigned char j_tmp;
	unsigned char oldy,oldd,oldm;
	
	i = ee_indx;
	j = ee_id;
	
	
	
	for(num_tmp=0;num_tmp<912;num_tmp++)
	{
		
		
		
		for(j_tmp=0;j_tmp<8;)
		{
			if(com_buf[14+j_tmp]==R_EROM(i,j*32+j_tmp+3))
				j_tmp++;
			else
				break;			
		}
		
		if(j_tmp==8)
		{
			oldy = R_EROM(i,j*32);
			oldm = R_EROM(i,j*32+1);
			oldd = R_EROM(i,j*32+2);
		//如果UID相同，则看年月是否满足要求
			if(y>oldy)
			{
				
				dis = 365-oldm*30-oldd+m*30+d;
				
			}
			else
				dis = m*30+d-oldm*30-oldd;
			if(dis>=Time_Range)
				return 0x01;
			else
				return 0x00;
		}
		else
		{
			if(j == 0)
			{
				j = 15;
				if(i == 0)
					i = 56;
				else
					i = i-1;
			}
			else
				j = j-1;
		}
				
	}
	
	
	
	

	return 0x01;
}






/////////////////////////////////////////////////////////////////////
//延时子程序
/////////////////////////////////////////////////////////////////////
void DelayMs(unsigned int _MS)
{

while(_MS--)
 {
     //大致延时1ms
     Delay_50us(245);
	 Delay_50us(245);
 }
}
void Delay_50us(unsigned char _50us)
{
 while(--_50us);
}
void flesh_set()
{ 
 	 if(set_num == 1)  {
     switch(tab_num)
		{
		   case 0:  WriteCommand(0x91);
					WriteData('0'+t_tmp[0]/16);
					WriteData('0'+t_tmp[0]%16);
					break;
		   case 1:  WriteCommand(0x93);
					WriteData('0'+t_tmp[1]/16);
					WriteData('0'+t_tmp[1]%16);
					break;
		   case 2:  WriteCommand(0x95);
					WriteData('0'+t_tmp[2]/16);
					WriteData('0'+t_tmp[2]%16);
					break;
		   case 3:  WriteCommand(0x88);
					WriteData('0'+t_tmp[3]/16);
					WriteData('0'+t_tmp[3]%16);
					break;
		   case 4:  WriteCommand(0x8a);
		   
					WriteData('0'+t_tmp[4]/16);
					WriteData('0'+t_tmp[4]%16);
					break;
//		   case 5:  WriteCommand(0x91);
//					WriteData('0'+year/16);
//					WriteData('0'+year%16);
//					tab_num = 0;
					//break;
		   default: break;
		}
		}

		 if(set_num == 3)  {
     switch(tab_num)
		{
		   case 0:  WriteCommand(0x93);
					WriteData('0'+set_led_time[0]/10);
					WriteData('0'+set_led_time[0]%10);
					break;
		   case 1:  WriteCommand(0x95);
					WriteData('0'+set_led_time[1]/10);
					WriteData('0'+set_led_time[1]%10);
					break;
		   case 2:  WriteCommand(0x8b);
					WriteData('0'+set_led_time[2]/10);
					WriteData('0'+set_led_time[2]%10);
					break;
		   case 3:  WriteCommand(0x8d);
					WriteData('0'+set_led_time[3]/10);
					WriteData('0'+set_led_time[3]%10);
					break;

		   default: break;
		}
		}
		 
		if(set_num == 4)  {
     switch(tab_num)
		{
		   case 0:  WriteCommand(0x89);
		   			WriteData(0x30+num[0]);		           				
					break;
		   case 1:  WriteCommand(0x89);
		   			WriteData(0x30+num[0]);
					WriteData(0x30+num[1]);					
					break;
		   case 2:  WriteCommand(0x8a);
		   			WriteData(0x30+num[2]);		           				
					break;
		   case 3:  WriteCommand(0x8a);
		   			WriteData(0x30+num[2]);
					WriteData(0x30+num[3]);					
					break;
		   case 4:  WriteCommand(0x8b);
		   			WriteData(0x30+num[4]);		           				
					break;
		   case 5:  WriteCommand(0x8b);
		   			WriteData(0x30+num[4]);
					WriteData(0x30+num[5]);					
					break;
		   case 6:  WriteCommand(0x8c);
		   			WriteData(0x30+num[6]);		           				
					break;
		   case 7:  WriteCommand(0x8c);
		   			WriteData(0x30+num[6]);
					WriteData(0x30+num[7]);					
					break;
		   case 8:  WriteCommand(0x8d);
		   			WriteData(0x30+num[8]);		           				
					break;
		   case 9:  WriteCommand(0x8d);
		   			WriteData(0x30+num[8]);
					WriteData(0x30+num[9]);					
					break;
		   case 10:  WriteCommand(0x8e);
		   			WriteData(0x30+num[10]);		           				
					break;
		  
		   default: break;
		}
		}


			if(set_num == 5)  {
     switch(tab_num)
		{
		   case 0:  WriteCommand(0x8a);
		   			WriteData(0x30+mach_num[0]);		           				
					break;
		   case 1:  WriteCommand(0x8a);
		   			WriteData(0x30+mach_num[0]);
					WriteData(0x30+mach_num[1]);					
					break;
		   case 2:  WriteCommand(0x8b);
		   			WriteData(0x30+mach_num[2]);		           				
					break;
		   case 3:  WriteCommand(0x8b);
		   			WriteData(0x30+mach_num[2]);
					WriteData(0x30+mach_num[3]);					
					break;
		   case 4:  WriteCommand(0x8c);
		   			WriteData(0x30+mach_num[4]);		           				
					break;
		   case 5:  WriteCommand(0x8c);
		   			WriteData(0x30+mach_num[4]);
					WriteData(0x30+mach_num[5]);					
					break;
		   case 6:  WriteCommand(0x8d);
		   			WriteData(0x30+mach_num[6]);		           				
					break;
		   case 7:  WriteCommand(0x8d);
		   			WriteData(0x30+mach_num[6]);
					WriteData(0x30+mach_num[7]);					
					break;
		   case 8:  WriteCommand(0x8e);
		   			WriteData(0x30+mach_num[8]);		           				
					break;
		   
		  
		   default: break;
		}
		}
		b_flesh = 0;
}



void flesh_clr()
{ 


 	    if(set_num == 1)  {
     switch(tab_num)
		{
		   case 0:  LCD_PutString(1,2,"  ");
		           
				
					break;
		   case 1:  LCD_PutString(3,2,"  ");
		           
					
					break;
		   case 2:  LCD_PutString(5,2,"  ");
		           
				
					break;
		   case 3:  LCD_PutString(0,3,"  ");
		            
				
					break;
		   case 4:  LCD_PutString(2,3,"  ");
		            
					break;

		   default: break;
		}
		}



		 if(set_num == 3)  {
     switch(tab_num)
		{
		   case 0:  LCD_PutString(3,2,"  ");		           				
					break;
		   case 1:  LCD_PutString(5,2,"  ");					
					break;
		   case 2:  LCD_PutString(3,3,"  ");				
					break;
		   case 3:  LCD_PutString(5,3,"  ");				
					break;
		   default: break;
		}
		}
		 
		if(set_num == 4)  {
     switch(tab_num)
		{
		   case 0:  WriteCommand(0x89);
		   			WriteData(0x20);		           				
					break;
		   case 1:  WriteCommand(0x89);
		   			WriteData(0x30+num[0]);
					WriteData(0x20);					
					break;
		   case 2:  WriteCommand(0x8a);
		   			WriteData(0x20);		           				
					break;
		   case 3:  WriteCommand(0x8a);
		   			WriteData(0x30+num[2]);
					WriteData(0x20);					
					break;
		   case 4:  WriteCommand(0x8b);
		   			WriteData(0x20);		           				
					break;
		   case 5:  WriteCommand(0x8b);
		   			WriteData(0x30+num[4]);
					WriteData(0x20);					
					break;
		   case 6:  WriteCommand(0x8c);
		   			WriteData(0x20);		           				
					break;
		   case 7:  WriteCommand(0x8c);
		   			WriteData(0x30+num[6]);
					WriteData(0x20);					
					break;
		   case 8:  WriteCommand(0x8d);
		   			WriteData(0x20);		           				
					break;
		   case 9:  WriteCommand(0x8d);
		   			WriteData(0x30+num[8]);
					WriteData(0x20);					
					break;
		   case 10:  WriteCommand(0x8e);
		   			WriteData(0x20);		           				
					break;
		  
		   default: break;
		}
		}





			if(set_num == 5)  {
     switch(tab_num)
		{
		   case 0:  WriteCommand(0x8a);
		   			WriteData(0x20);		           				
					break;
		   case 1:  WriteCommand(0x8a);
		   			WriteData(0x30+mach_num[0]);
					WriteData(0x20);					
					break;
		   case 2:  WriteCommand(0x8b);
		   			WriteData(0x20);		           				
					break;
		   case 3:  WriteCommand(0x8b);
		   			WriteData(0x30+mach_num[2]);
					WriteData(0x20);					
					break;
		   case 4:  WriteCommand(0x8c);
		   			WriteData(0x20);		           				
					break;
		   case 5:  WriteCommand(0x8c);
		   			WriteData(0x30+mach_num[4]);
					WriteData(0x20);					
					break;
		   case 6:  WriteCommand(0x8d);
		   			WriteData(0x20);		           				
					break;
		   case 7:  WriteCommand(0x8d);
		   			WriteData(0x30+mach_num[6]);
					WriteData(0x20);					
					break;
		   case 8:  WriteCommand(0x8e);
		   			WriteData(0x20);		           				
					break;
		   default: break;
		}
		}
		b_flesh = 0;
}

void user_ch()
{
	if(SCH1 == 0)
	{
		Delay_50us(50);
		if(SCH1 == 0){
				if(out1 == 0){
					select_ch(CH1);
				chan_chose = 1;
				ch1_ans = 1;}
				else{
					set_num = NO_INV_STATE;
					if(ch1_ans == 1)
					{
						//message(num,mach_num,1);
						send_no_goods = 1;
						no_goods_chan = 1;
					}
					ch1_ans = 0;
				
				}
			}
	}
	if(TAB == 0)
	{
		Delay_50us(50);
	if(TAB == 0){
				if(out2 == 0){
					chan_chose = 2;
					select_ch(CH2);
				ch2_ans = 1;}
				else{
					set_num = NO_INV_STATE;
					if(ch2_ans == 1)
					{
						//message(num,mach_num,2);
						send_no_goods = 1;
						no_goods_chan = 2;
					}
					ch2_ans = 0;
				
				}
			}
	}
	if(INC == 0)
	{
		Delay_50us(50);
		if(INC == 0){
				if(out3 == 0){
					chan_chose = 3;
					select_ch(CH3);
				ch3_ans = 1;}
				else
				{
					set_num = NO_INV_STATE;
				if(ch3_ans == 1)
				{
						//message(num,mach_num,3);
					send_no_goods = 1;
						no_goods_chan = 3;
				}
					ch3_ans = 0;
			}
			}
	}
	if(SUB == 0)
	{
		Delay_50us(50);
		if(SUB == 0){
				if(out4 == 0){
					chan_chose = 4;
					select_ch(CH4);
				ch4_ans = 1;}
				else
				{
					set_num = NO_INV_STATE;
				if(ch4_ans == 1)
				{
						//message(num,mach_num,4);
					send_no_goods = 1;
						no_goods_chan = 4;
				}
					ch4_ans = 0;
			}
				
			}
	}
	if(set_num == NO_INV_STATE){
		DisplayLcd(NO_INV);
		/* BEEP(30);
		DelayMs(400);
		BEEP(30);
		DelayMs(400);
		BEEP(30); */
		if(send_no_goods == 1)
		{
			message(num,no_goods_chan);
			send_no_goods = 0;
		}
		set_num = USER_STATE;
		tmp_show = 0;
		sc_speech(6);
		 }
}


void select_ch(uchar channel)
{
//	uchar s;
//	Write_E(ee_indx,ee_id*2,(nian-10)*16+yue);
//	Write_E(ee_indx,ee_id*2+1,ri);
//	
//	DelayMs(1000);
	uchar ri,yue,nian;

	ri=DS1302Read(0x87);
 	yue=DS1302Read(0x89);
 	nian=DS1302Read(0x8d);
 	ri=ri/16*10+ri%16;
 	yue=yue/16*10+yue%16;
 	nian=nian/16*10+nian%16;
	Write_EE_rec(nian,yue,ri);
	DelayMs(150);
	num_times++;
	
	Write_E(57,29,num_times%10);
	Write_E(57,30,num_times/10%10);
	Write_E(57,31,num_times/100%10);
	Write_E(57,32,num_times/1000%10);
	
		if(channel == CH1){
		MENTOR(1,ZHEN);
		DelayMs(10);
		user_channel = 1;
		}
	if(channel == CH2){
		MENTOR(2,ZHEN);
		DelayMs(10);
		user_channel = 2;
		}
	if(channel == CH3){
		MENTOR(3,ZHEN);
		DelayMs(10);
		user_channel = 3;
		}
	if(channel == CH4){ 
		MENTOR(4,ZHEN);	
		DelayMs(10);
		user_channel = 4;
		}
	set_num=GET_INV_STATE;	
	
	TR0 = 0;
	tmp_show = 0;
	a=0;
	
	TH0 = 0Xc8;
	TL0 = 0Xc0;
	TR0 = 1;
		
}
void Ini_UART(void)//串口初始化、定时器初始化
{
	AUXR &= 0XBE;
	AUXR1 = 0X00;//串口在3.0,3.1
	SCON = 0x50 ;  //SCON: serail mode 1, 8-bit UART, enable ucvr
    //UART为模式1，8位数据，允许接收
    TMOD |= 0x20 ; //TMOD: timer 1, mode 2, 8-bit reload
    //定时器1为模式2,8位自动重装
    PCON |= 0x80 ; //SMOD=1;
    TH1 = 0xFF ;   //Baud:115200 fosc=22.1184MHz
    TL1=0xFF;
    //IE |= 0x90 ;     //Enable Serial Interrupt
	ES=1;
    TR1 = 1 ;       // timer 1 run
 
}

void IDR_Request()
{
	uchar i;
	ES=0;
	for(i=0;i<sizeof(SAM_V_FIND);i++)
	{
		SBUF=SAM_V_FIND[i]; //送入缓冲区
		while(TI!=1); //等待发送完毕
		TI=0;
	}
	recv_num=0;
	ES=1;
	
}
	
void IDR_Select()
{
	uchar i;
	ES=0;
	for(i=0;i<sizeof(SAM_V_SELE);i++)
	{
		SBUF=SAM_V_SELE[i]; //送入缓冲区
		while(TI!=1); //等待发送完毕
		TI=0;
	}
	
	recv_num=0;	
	ES=1;
}
	
void IDR_Read()
{
	uchar i;
	ES=0;
	for(i=0;i<sizeof(SAM_V_READ);i++)
	{
		SBUF=SAM_V_READ[i]; //送入缓冲区
		while(TI!=1); //等待发送完毕
		TI=0;
	}
	
	recv_num=0;
	ES=1;
}


void T0_time() interrupt 1
{
	TH0 = 0Xc8;
	TL0 = 0Xc0;

	a++;
	aa++;

	if(start_long_set==1){
		if(a%20==0){
			long_set+=1;}
			}
	

	if(aa == 15000){
	aa = 0;
	update_logo = 1;
	}	
	if(aa%50 == 0)
	ask_it = 1;

	if(a == 40)
	{	
		a = 0;
		tmp_show+=1;
	b=~b;	
	b_flesh = 1;	
	}
}	
void ser() interrupt 4	   //串口中断服务
{
	if(RI == 1)
	{
		RI = 0;
	
		
		
	if(AUXR1 == 0X40){	
			com2_cmd_buf[com2_cmd_num] = SBUF;
			com2_cmd_num++;
		
			if(com2_cmd_num>1)
			{
				if((com2_cmd_buf[com2_cmd_num-1] == 10)&&(com2_cmd_buf[com2_cmd_num-2] == 13))
				{
				com2_cmd_num=0;
				}
			 }
		}
	else{	
			com_buf[recv_num]=SBUF;
	recv_num++;
	if(recv_num==173)
		recv_num=172;  }
		
	}
	
}

/* void ser2() interrupt 8	   //串口中断服务
{

//com2_buf[12];com2_cmd_buf[100]
	if(S2CON & 0X01)
	{
		S2CON &= 0XFE;
	
		com2_cmd_buf[com2_cmd_num] = S2BUF;
		com2_cmd_num++;
			
		
		
		if(com2_cmd_num>1)
		{
			if((com2_cmd_buf[com2_cmd_num-1] == 10)&&(com2_cmd_buf[com2_cmd_num-2] == 13))
			{
			com2_cmd_num=0;
			}
		 }
		
		
		
	}
	
} */




